\RequirePackage{xparse,array,l3keys2e}

\ProvidesExplPackage
  {onecell} {2017/09/18}
  {v0.1}    {Place contents into a single cell}

% code from https://tex.stackexchange.com/a/358114/117050
\newcolumntype{?}{!{\d@llarend&\span\@gobbletwo}}

\ExplSyntaxOn
\tl_new:N \l_onecell_align_tl
\tl_new:N \l_onecell_columns_tl
\tl_new:N \l_onecell_use_cols_tl

\NewDocumentCommand{\onecell}%
{
  s 
  >{ \onecell_excl:n }t!
  >{ \onecell_processor_Optional_O:Vn \l_onecell_columns_tl }O{}
  O{\l_onecell_align_tl}
  +m
}{{
  \onecell_starred:Nn{#1}{\hspace*{-\tabcolsep}}
  \cs_set_nopar:Nn \onecell_tabular: { \begin{tabular}[#4] }
  \exp_args:Nx \onecell_tabular: { #3 \IfBooleanF{ #2 }{ ?#3 } }
    #5%
  \end{tabular}
  \onecell_starred:Nn{#1}{\hspace*{-\tabcolsep}}
}}

\cs_new:Nn \onecell_processor_Optional_O:nn {
  \tl_if_empty:nTF { #2 }
    { \def\ProcessedArgument{#1} }
    { \def\ProcessedArgument{#2} }
}
\cs_generate_variant:Nn \onecell_processor_Optional_O:nn { Vn }

\msg_new:nnn { onecell } { unknown_key }
  { The~key~#1~is~unknown~and~therefore~ignored! }

\NewDocumentCommand{\onecellOptions}{ +m }{%
  \keys_set:nn { onecell } { #1 }}

\keys_define:nn { onecell } {
  ,col     .tl_set_x:N       = \l_onecell_columns_tl
  ,col     .value_required:n = true
  ,columns .meta:n           = { col = #1 }
  ,align   .tl_set_x:N       = \l_onecell_align_tl
  ,pad     .choice:
  ,pad     / remove .code:n  = \cs_set_eq:NN \onecell_starred:Nn \IfBooleanF
  ,pad     / leave  .code:n  = \cs_set_eq:NN \onecell_starred:Nn \IfBooleanT
  ,pad     .value_required:n = true
  ,repeat  .choice:
  ,repeat  / true   .code:n  = \cs_new_nopar:Npn \onecell_excl:n ##1 {
    \def\ProcessedArgument{##1} }
  ,repeat  / false  .code:n  = \cs_set_eq:NN \onecell_excl:n \ReverseBoolean
  ,repeat  .default:n        = true
  ,default .meta:n           = {
    ,col   = c
    ,align = c
    ,pad   = remove
    ,repeat
  }
  ,default .value_forbidden:n = true
  ,unknown .code:n     = {
    \msg_error:nnx { onecell } { unknown_key } { \l_keys_key_tl }
  }
}

\keys_set:nn { onecell } { default }

\ProcessKeysOptions { onecell }
\ExplSyntaxOff
